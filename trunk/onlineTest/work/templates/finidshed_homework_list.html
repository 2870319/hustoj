{% extends 'base.html' %}
{% block extrahead %}
    {% load static %}
    <link href="{% static 'assets/css/bootstrap-table.min.css' %}" rel="stylesheet">
    <script src="{% static 'assets/js/jquery-3.2.1.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap-table-zh-CN.min.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap-table-export.min.js' %}"></script>
    <script src="{% static 'assets/js/tableExport.js' %}"></script>
{% endblock %}
{% block content %}
    <style type="text/css">
    <!--
    table td{word-break: keep-all;}
    -->
    </style>
    <!--下载进度条-->
    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="myModal" style="display:none;margin-top:200px" data-backdrop="static">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background-color: white">
                    <button id="closeModal" type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h3 class="modal-title" id="myModalLabel" style="text-align: center;color:black">本操作需要的时间较多，请您请耐心等待...</h3>
                </div>
                <div class="progress" style="margin: 20px" id="loading-out">
                    <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:0" id="loading">
                        <span class="sr-only">40% Complete (success)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--进度条结束-->
    <ol class="breadcrumb">
        <li><a href="{% url 'index' %}">主页</a></li>
        <li class="active">查看作业结果</li>
    </ol>
    <div id="toolbar">
        <div class="form-inline" role="form">
            <div class="form-group">
                <select class="form-control" id="classname" name="classname">
                    <option value="0" selected="selected">请选择需要查询的班级</option>
                    {% for classname in classnames %}
                        <option value="{{ classname.pk }}">{{ classname.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button data-toggle="modal" data-target="#myModal" id="ok" type="submit" class="btn btn-default">开始查询</button>
        </div>
    </div>
    <table id="table"
           data-side-pagination="server"
           data-pagination="true"
           data-classes="table table-hover table-condensed"
           data-toolbar="#toolbar"
           data-striped="true"
           data-query-params="queryParams"
           data-show-export="true"
    >
    </table>
    <script>
        $.ajaxSetup({
            data: {csrfmiddlewaretoken: '{{ csrf_token }}'}
        });
        var $table = $('#table');
        var clock;
        function queryParams(params) {
            $('#toolbar').find('select[name]').each(function () {
                params[$(this).attr('name')] = $(this).val();
            });
            params['my'] = false;
            return params;
        }

        $ok = $('#ok');
        $(function () {
            $('#ok').click(function () {
                $('#table').bootstrapTable('destroy').bootstrapTable({
                    url: "{% url 'get_finished_homework' %}",
                    sidePagination: 'server',
                    pagination: true
                });
                var w=0;
                $('#loading').css({'width':0});
                clock=self.setInterval(function(){
                    if(w>90)
                        w = w + 1;
                    else if(w>70)
                        w = w + 2;
                    else if(w>50)
                        w = w + 3;
                    else if(w>30)
                        w = w + 4;
                    else
                        w = w + 5;
                    $('#loading').css({'width':w+'%'});
                    //console.log(w+'%');
                },2000);
            });
        });

        function showTable($el, scores){
            //alert('showTable'+JSON.stringify(scores));
            scores = eval('(' + JSON.stringify(scores) + ')');
            var i, j, row,
                columns = [],
                data = [];

            colCount = 0;
            if(scores.length!=undefined)
                for(var i in scores[0])
                    colCount++;

            columns.push({field: 'id',title: '学号'});
            columns.push({field: 'name',title: '姓名'});
            for (i = 1; i < colCount-1; i++) {
                columns.push({
                    field: 'score' + i,
                    title: '作业' + i,
                    align: 'center',
                    formatter: scoreFormatter
                });
            }
            for (var i in scores) {
                student = eval('(' + JSON.stringify(scores[i]) + ')');
                row = {};
                row['id'] = student['id'];
                row['name'] = student['name'];
                for (j = 1; j < colCount-1; j++) {
                    row['score' + j] = student['score' + j];
                }
                data.push(row);
            }

            $el.bootstrapTable('destroy').bootstrapTable({
                columns: columns,
                data: data,
                sidePagination: 'client',
                pagination: true,
                pageSize: 500,
                pageList: []
            }); 
        }
        
        function scoreFormatter(value, row, index){
            if(value['score']=='无')
                return '无';
            else
                return '<a target="_blank" href="/test/work/homework-result-' + value['pk'] + '/" title="查看详细">' + value['score'] + '</a>';
        }

        $('#table').on('load-success.bs.table', function () {
            //window.alert('load-success');
            data = $('#table').bootstrapTable('getData');
            showTable($('#table'),data);
            $('#loading').animate({'width':'100%'},200);
            window.clearInterval(clock);
            //$('#myModal').modal('hide');
            setTimeout(function(){$('#closeModal').trigger('click');},1000);
        });

        function buildTable($el){
            $el.bootstrapTable({
                url: "{% url 'get_finished_homework' %}",
                sidePagination: 'server',
                pagination: true
            });
        }

        $(function () {
            buildTable($('#table'));
        });
    </script>

{% endblock %}
